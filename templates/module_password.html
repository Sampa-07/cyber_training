{% extends "base.html" %}

{% block extra_css %}
<style>
  .password-meter {
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
  }
  .strength-bar {
    height: 100%;
    width: 0%;
    transition: width 0.3s ease, background-color 0.3s ease;
  }
  .password-history-item {
    border-left: 3px solid #0d6efd;
    padding-left: 10px;
    margin-bottom: 8px;
  }
</style>
{% endblock %}

{% block content %}
<!-- Module Header -->
<div class="card p-4 mb-4 shadow-sm border-0 bg-light">
  <div class="d-flex align-items-center">
    <div class="flex-grow-1">
      <h1 class="mb-2">Password Security</h1>
      <p class="lead text-secondary">Master strong password creation and management</p>
    </div>
    <div class="badge bg-primary rounded-pill p-2">Essential</div>
  </div>
  <div class="progress mt-3" style="height: 6px;">
    <div class="progress-bar bg-success" style="width: {% if module_progress['completion_status'] == 1 %}100{% else %}50{% endif %}%"></div>
  </div>
</div>

<!-- Main Content -->
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card p-4 shadow-sm border-0 h-100">
      <h3><i class="bi bi-key me-2"></i>Password Creation Challenge</h3>
      
      <div class="mb-4">
        <label for="passInput" class="form-label">Test your password strength:</label>
        <div class="input-group">
          <input id="passInput" type="password" class="form-control" placeholder="Type a password" autocomplete="new-password">
          <button id="toggleVisibility" class="btn btn-outline-secondary" type="button">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <div class="password-meter mt-2">
          <div id="strengthBar" class="strength-bar"></div>
        </div>
        <p id="strengthText" class="small mt-1">Strength: <span class="fw-semibold">—</span></p>
        <ul id="feedbackList" class="list-unstyled small"></ul>
      </div>

      <div class="alert alert-info">
        <h5 class="alert-heading"><i class="bi bi-lightbulb me-2"></i>Requirements</h5>
        <ol class="mb-0">
          <li id="challenge1">Minimum 12 characters</li>
          <li id="challenge2">Uppercase + lowercase letters</li>
          <li id="challenge3">Numbers and symbols</li>
          <li id="challenge4">No common patterns</li>
        </ol>
      </div>

      <div class="mt-4">
        <button id="completeBtn" class="btn btn-primary me-2" {% if module_progress['completion_status'] == 1 %}disabled{% endif %}>
          <i class="bi bi-check-circle me-2"></i>
          {% if module_progress['completion_status'] == 1 %}Completed{% else %}Mark Complete{% endif %}
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-2"></i>Dashboard
        </a>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <div class="card p-4 shadow-sm border-0 h-100">
      <h4><i class="bi bi-graph-up me-2"></i>Your Progress</h4>
      <div class="d-flex align-items-center mb-3">
        <div class="progress flex-grow-1" style="height: 6px;">
          <div class="progress-bar bg-success" style="width: {% if module_progress['completion_status'] == 1 %}100{% else %}50{% endif %}%"></div>
        </div>
        <span class="ms-2">{% if module_progress['completion_status'] == 1 %}100%{% else %}50%{% endif %}</span>
      </div>

      <h5><i class="bi bi-clock-history me-2"></i>Recent Attempts</h5>
      {% if history %}
        {% for entry in history %}
        <div class="password-history-item">
          <div class="d-flex justify-content-between">
            <span>Attempt {{ loop.index }}</span>
            <strong>{{ entry['strength_score'] }}/100</strong>
          </div>
          <small class="text-muted">{{ entry['created_at'] }}</small>
        </div>
        {% endfor %}
      {% else %}
        <p class="small text-muted">No attempts yet</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Educational Content -->
<!-- ===== SECTION 1: Password Fundamentals ===== -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h3><i class="bi bi-key me-2"></i>Password Fundamentals</h3>
    
    <div class="row mt-3">
      <!-- Password Anatomy -->
      <div class="col-md-6">
        <div class="card h-100 border-0">
          <div class="card-body">
            <h5><i class="bi bi-puzzle me-2"></i>Anatomy of a Strong Password</h5>
            <ul>
              <li><strong>12+ characters</strong> (longer is better)</li>
              <li><strong>Upper + lowercase</strong> letters (e.g., <code>Aa</code>)</li>
              <li><strong>Numbers</strong> (e.g., <code>9</code>)</li>
              <li><strong>Symbols</strong> (e.g., <code>!@#$%</code>)</li>
              <li><strong>No personal info</strong> (names, birthdays)</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Common Attacks -->
      <div class="col-md-6">
        <div class="card h-100 border-0">
          <div class="card-body">
            <h5><i class="bi bi-shield-slash me-2"></i>How Hackers Crack Passwords</h5>
            <ul>
              <li><strong>Brute force:</strong> Trying all combinations</li>
              <li><strong>Dictionary attacks:</strong> Common words/phrases</li>
              <li><strong>Phishing:</strong> Tricking you to reveal passwords</li>
              <li><strong>Data breaches:</strong> Reusing passwords across sites</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== SECTION 2: Two-Factor Authentication ===== -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h3><i class="bi bi-shield-lock me-2"></i>Two-Factor Authentication (2FA)</h3>
    
    <div class="alert alert-primary">
      <i class="bi bi-info-circle me-2"></i>
      <strong>2FA blocks 99.9% of account takeovers</strong> even if your password is stolen.
    </div>
    
    <div class="row mt-3">
      <!-- 2FA Methods -->
      <div class="col-md-4">
        <div class="card h-100 border-0">
          <div class="card-body">
            <h5><i class="bi bi-phone me-2"></i>SMS/Text</h5>
            <p><strong>Pros:</strong> Easy to use</p>
            <p><strong>Cons:</strong> Vulnerable to SIM swapping</p>
            <p class="text-muted small">Security: ★★☆☆☆</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100 border-0">
          <div class="card-body">
            <h5><i class="bi bi-app-indicator me-2"></i>Authenticator Apps</h5>
            <p><strong>Pros:</strong> No network needed</p>
            <p><strong>Cons:</strong> Requires setup</p>
            <p class="text-muted small">Security: ★★★★☆</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100 border-0">
          <div class="card-body">
            <h5><i class="bi bi-usb-drive me-2"></i>Hardware Keys</h5>
            <p><strong>Pros:</strong> Unphishable</p>
            <p><strong>Cons:</strong> Cost ($20-$50)</p>
            <p class="text-muted small">Security: ★★★★★</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== SECTION 3: Password Managers ===== -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <h3><i class="bi bi-database-lock me-2"></i>Password Managers</h3>
    
    <div class="row">
      <div class="col-md-6">
        <h5><i class="bi bi-check-circle me-2"></i>Why Use One?</h5>
        <ul>
          <li>Generates/store <strong>unique passwords</strong> for every site</li>
          <li>Auto-fills passwords <strong>securely</strong></li>
          <li>Alerts you about <strong>compromised passwords</strong></li>
        </ul>
      </div>
      <div class="col-md-6">
        <h5><i class="bi bi-shield-check me-2"></i>Recommended Options</h5>
        <ul>
          <li><strong>Bitwarden</strong> (Free + Open Source)</li>
          <li><strong>1Password</strong> (User-friendly)</li>
          <li><strong>KeePass</strong> (Local storage only)</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<!-- ===== SECTION 4: Knowledge Check ===== -->
<div class="card shadow-sm border-0">
  <div class="card-body">
    <h3><i class="bi bi-patch-question me-2"></i>Knowledge Check</h3>
    <p class="text-danger"><i class="bi bi-exclamation-triangle me-2"></i>You must score 80% to complete this module.</p>
    
    <form id="securityQuiz">
      <!-- Question 1 -->
      <div class="mb-4">
        <p class="fw-bold">1. What's the minimum recommended password length?</p>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q1" id="q1a" value="A" required>
          <label class="form-check-label" for="q1a">8 characters</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q1" id="q1b" value="B">
          <label class="form-check-label" for="q1b">12 characters</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q1" id="q1c" value="C">
          <label class="form-check-label" for="q1c">6 characters</label>
        </div>
      </div>
      
      <!-- Question 2 -->
      <div class="mb-4">
        <p class="fw-bold">2. Which 2FA method is MOST secure?</p>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q2" id="q2a" value="A" required>
          <label class="form-check-label" for="q2a">Text message (SMS)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q2" id="q2b" value="B">
          <label class="form-check-label" for="q2b">Authenticator app</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q2" id="q2c" value="C">
          <label class="form-check-label" for="q2c">Email verification</label>
        </div>
      </div>
      
      <!-- Question 3 -->
      <div class="mb-4">
        <p class="fw-bold">3. True or False: Reusing passwords across multiple sites is safe if the password is strong.</p>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q3" id="q3a" value="A" required>
          <label class="form-check-label" for="q3a">True</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q3" id="q3b" value="B">
          <label class="form-check-label" for="q3b">False</label>
        </div>
      </div>
      
      <!-- Question 4 -->
      <div class="mb-4">
        <p class="fw-bold">4. What should you do if a service you use suffers a data breach?</p>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q4" id="q4a" value="A" required>
          <label class="form-check-label" for="q4a">Change your password immediately</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q4" id="q4b" value="B">
          <label class="form-check-label" for="q4b">Enable 2FA if available</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q4" id="q4c" value="C">
          <label class="form-check-label" for="q4c">Both A and B</label>
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary">Submit Quiz</button>
    </form>
    
    <!-- Quiz Results (Hidden Initially) -->
    <div id="quizResults" class="mt-4 d-none">
      <div class="alert">
        <h4><i class="bi bi-award me-2"></i>Results: <span id="quizScore">0</span>/4</h4>
        <p id="quizFeedback"></p>
        <div id="moduleCompleteAlert" class="alert alert-success d-none">
          <i class="bi bi-check-circle me-2"></i>
          <strong>Module Complete!</strong> You may now proceed.
        </div>
        <div id="quizRetryAlert" class="alert alert-danger d-none">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Try again!</strong> You need at least 3 correct answers to complete this module.
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Password strength evaluation
  function evaluatePassword(password) {
    let score = 0;
    const feedback = [];
    
    // Length check (max 25 points)
    if (password.length >= 12) {
      score += Math.min(25, password.length * 2);
      document.getElementById('challenge1').innerHTML = '<i class="bi bi-check-circle-fill text-success me-1"></i>Minimum 12 characters';
    } else {
      document.getElementById('challenge1').innerHTML = '<i class="bi bi-x-circle-fill text-danger me-1"></i>Minimum 12 characters';
      feedback.push('Use at least 12 characters');
    }
    
    // Character variety (max 35 points)
    const hasLower = /[a-z]/.test(password);
    const hasUpper = /[A-Z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    const hasSymbol = /[^a-zA-Z0-9]/.test(password);
    
    if (hasLower && hasUpper) {
      score += 15;
      document.getElementById('challenge2').innerHTML = '<i class="bi bi-check-circle-fill text-success me-1"></i>Uppercase + lowercase letters';
    } else {
      document.getElementById('challenge2').innerHTML = '<i class="bi bi-x-circle-fill text-danger me-1"></i>Uppercase + lowercase letters';
      feedback.push('Mix uppercase and lowercase letters');
    }
    
    if (hasNumber && hasSymbol) {
      score += 20;
      document.getElementById('challenge3').innerHTML = '<i class="bi bi-check-circle-fill text-success me-1"></i>Numbers and symbols';
    } else {
      document.getElementById('challenge3').innerHTML = '<i class="bi bi-x-circle-fill text-danger me-1"></i>Numbers and symbols';
      if (!hasNumber) feedback.push('Include numbers');
      if (!hasSymbol) feedback.push('Add symbols (!@#$%)');
    }
    
    // Common patterns check (max 20 points)
    const badPatterns = ['password', '123456', 'qwerty', 'letmein'];
    const isCommon = badPatterns.some(p => password.toLowerCase().includes(p));
    
    if (!isCommon) {
      score += 20;
      document.getElementById('challenge4').innerHTML = '<i class="bi bi-check-circle-fill text-success me-1"></i>No common patterns';
    } else {
      document.getElementById('challenge4').innerHTML = '<i class="bi bi-x-circle-fill text-danger me-1"></i>No common patterns';
      feedback.push('Avoid common words/patterns');
    }
    
    return { score, feedback };
  }

  // Real-time password analysis
  document.getElementById('passInput').addEventListener('input', function() {
    const password = this.value;
    const { score, feedback } = evaluatePassword(password);
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const feedbackList = document.getElementById('feedbackList');
    
    // Update strength meter
    strengthBar.style.width = `${score}%`;
    strengthBar.style.backgroundColor = score < 40 ? '#dc3545' : 
                                      score < 70 ? '#fd7e14' : 
                                      score < 90 ? '#ffc107' : '#198754';
    
    // Update strength text
    const strengthLabel = score < 40 ? 'Weak' : 
                         score < 70 ? 'Moderate' : 
                         score < 90 ? 'Strong' : 'Very Strong';
    strengthText.innerHTML = `Strength: <span class="fw-semibold">${strengthLabel}</span>`;
    
    // Update feedback
    feedbackList.innerHTML = '';
    if (feedback.length > 0) {
      feedback.forEach(item => {
        const li = document.createElement('li');
        li.className = 'text-danger';
        li.innerHTML = `<i class="bi bi-exclamation-circle me-1"></i>${item}`;
        feedbackList.appendChild(li);
      });
    } else if (password.length > 0) {
      const li = document.createElement('li');
      li.className = 'text-success';
      li.innerHTML = '<i class="bi bi-check-circle me-1"></i>Excellent password!';
      feedbackList.appendChild(li);
    }
    
    // Enable complete button if score > 70
    document.getElementById('completeBtn').disabled = score < 70;
  });
  
  // Toggle password visibility
  document.getElementById('toggleVisibility').addEventListener('click', function() {
    const input = document.getElementById('passInput');
    const icon = this.querySelector('i');
    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.replace('bi-eye', 'bi-eye-slash');
    } else {
      input.type = 'password';
      icon.classList.replace('bi-eye-slash', 'bi-eye');
    }
  });
  
  // Mark module complete
  document.getElementById('completeBtn').addEventListener('click', function() {
    const password = document.getElementById('passInput').value;
    const score = parseInt(document.getElementById('strengthBar').style.width);
    
    fetch("{{ url_for('update_password_progress') }}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        password: password,
        strength_score: score,
        is_completed: true
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        window.location.reload();
      }
    });
  });
</script>
{% endblock %}